# 电影票务网站触发器设计文档

## 概述

本文档详细说明了电影票务网站数据库中实现的触发器系统，这些触发器完美对应业务流程，确保数据完整性、自动化业务规则并提升系统效率。

## 触发器分类

### 1. 数据完整性触发器

#### 1.1 Cinema 表触发器

**tr_cinema_before_insert**
- **触发时机**: INSERT 前
- **业务对应**: 影院信息录入验证
- **功能**: 
  - 验证影院名称完整性（非空，长度限制）
  - 验证地址格式和长度
  - 验证联系电话格式（支持多种格式）
- **业务价值**: 确保影院基础信息的准确性，避免无效数据录入

**tr_cinema_after_update**
- **触发时机**: UPDATE 后
- **业务对应**: 影院信息变更记录
- **功能**: 记录影院信息修改日志（预留接口）
- **业务价值**: 为审计和追踪提供基础

#### 1.2 Hall 表触发器

**tr_hall_before_insert**
- **触发时机**: INSERT 前
- **业务对应**: 影厅创建验证
- **功能**:
  - 验证影厅名称非空
  - 验证座位容量合理性（1-1000）
  - 验证所属影院存在性
- **业务价值**: 确保影厅配置的合理性和关联性

**tr_hall_before_delete**
- **触发时机**: DELETE 前
- **业务对应**: 影厅删除安全检查
- **功能**: 检查是否有未来场次安排
- **业务价值**: 防止误删除影响业务运营的影厅

#### 1.3 Movie 表触发器

**tr_movie_before_insert**
- **触发时机**: INSERT 前
- **业务对应**: 电影信息录入验证
- **功能**:
  - 验证电影标题非空
  - 验证时长合理性（1-600分钟）
  - 验证上映和撤档日期逻辑
  - 验证基础价格范围（0-1000元）
- **业务价值**: 确保电影信息的完整性和合理性

**tr_movie_after_update**
- **触发时机**: UPDATE 后
- **业务对应**: 电影价格调整自动化
- **功能**: 基础价格变化时自动调整未来场次票价
- **业务价值**: 实现价格策略的自动化执行

### 2. 用户管理触发器

#### 2.1 User 表触发器

**tr_user_before_insert**
- **触发时机**: INSERT 前
- **业务对应**: 用户注册验证
- **功能**:
  - 验证用户名格式（最少2字符）
  - 验证手机号格式（中国大陆11位）
  - 验证邮箱格式（标准邮箱格式）
  - 自动设置注册时间
- **业务价值**: 确保用户信息的有效性，提升用户体验

**tr_user_after_update**
- **触发时机**: UPDATE 后
- **业务对应**: 敏感信息变更监控
- **功能**: 记录手机号、邮箱、密码等敏感信息变更
- **业务价值**: 提供安全审计和异常监控能力

#### 2.2 Member 表触发器

**tr_member_before_insert**
- **触发时机**: INSERT 前
- **业务对应**: 会员注册验证
- **功能**:
  - 验证用户和影院存在性
  - 初始化积分为0
- **业务价值**: 确保会员关系的有效性

**tr_member_after_update**
- **触发时机**: UPDATE 后
- **业务对应**: 积分变化记录
- **功能**: 记录积分变化日志（预留接口）
- **业务价值**: 为积分审计和分析提供数据基础

### 3. 场次和座位管理触发器

#### 3.1 Screening 表触发器

**tr_screening_before_insert**
- **触发时机**: INSERT 前
- **业务对应**: 场次创建验证
- **功能**:
  - 验证电影和影厅存在性
  - 验证放映时间为未来时间
  - 验证票价合理性
  - 自动设置剩余座位数
- **业务价值**: 确保场次安排的合理性和完整性

**tr_screening_after_insert**
- **触发时机**: INSERT 后
- **业务对应**: 座位自动初始化
- **功能**: 根据影厅容量自动创建座位布局（20列布局）
- **业务价值**: 自动化座位管理，减少人工操作

**tr_screening_before_delete**
- **触发时机**: DELETE 前
- **业务对应**: 场次删除安全检查
- **功能**: 检查是否有已售出票务
- **业务价值**: 防止误删除影响用户权益的场次

#### 3.2 ScreeningSeat 表触发器

**tr_screening_seat_after_update**
- **触发时机**: UPDATE 后
- **业务对应**: 座位状态变化处理
- **功能**:
  - 自动更新场次剩余座位数
  - 自动设置/清除座位锁定时间
- **业务价值**: 实时维护座位状态，确保数据一致性

### 4. 团购票管理触发器

#### 4.1 GroupTicketType 表触发器

**tr_group_ticket_type_before_insert**
- **触发时机**: INSERT 前
- **业务对应**: 团购票类型创建验证
- **功能**:
  - 验证人数限制逻辑
  - 验证价格合理性
  - 验证有效日期
  - 验证库存非负
- **业务价值**: 确保团购票配置的合理性

**tr_group_ticket_type_before_update**
- **触发时机**: UPDATE 前
- **业务对应**: 过期票型自动下架
- **功能**: 过期票型自动设置为下架状态
- **业务价值**: 自动化票型生命周期管理

#### 4.2 PurchasedGroupTicket 表触发器

**tr_purchased_group_ticket_before_insert**
- **触发时机**: INSERT 前
- **业务对应**: 团购票购买验证
- **功能**:
  - 验证票型存在性和上架状态
  - 验证购买数量在限制范围内
  - 验证库存充足性
- **业务价值**: 确保团购票购买的有效性

**tr_purchased_group_ticket_after_insert**
- **触发时机**: INSERT 后
- **业务对应**: 库存自动扣减
- **功能**: 自动减少对应票型库存
- **业务价值**: 实时维护库存状态

### 5. 订单管理触发器

#### 5.1 Order 表触发器

**tr_order_before_insert**
- **触发时机**: INSERT 前
- **业务对应**: 订单创建处理
- **功能**:
  - 自动生成唯一订单号
  - 自动设置订单和支付时间
  - 验证支付金额合理性
- **业务价值**: 自动化订单编号管理，确保订单信息完整

**tr_order_after_update**
- **触发时机**: UPDATE 后
- **业务对应**: 订单状态变化处理
- **功能**: 订单取消时自动释放座位
- **业务价值**: 自动化座位资源回收

### 6. 验证券管理触发器

#### 6.1 Verification 表触发器

**tr_verification_before_insert**
- **触发时机**: INSERT 前
- **业务对应**: 验证券生成
- **功能**: 自动生成唯一16位核验码
- **业务价值**: 确保验证券的唯一性和安全性

**tr_verification_after_update**
- **触发时机**: UPDATE 后
- **业务对应**: 验证券核销处理
- **功能**:
  - 自动设置使用时间
  - 自动标记座位为已售出
- **业务价值**: 自动化核销流程，确保座位状态同步

### 7. 评论管理触发器

#### 7.1 Review 表触发器

**tr_review_before_insert**
- **触发时机**: INSERT 前
- **业务对应**: 评论权限验证
- **功能**:
  - 验证用户是否观看过该场次
  - 自动设置评论时间
- **业务价值**: 确保评论的真实性和有效性

**tr_review_after_insert**
- **触发时机**: INSERT 后
- **业务对应**: 电影评分更新
- **功能**: 自动重新计算电影平均评分
- **业务价值**: 实时维护电影评分准确性

**tr_review_after_update**
- **触发时机**: UPDATE 后
- **业务对应**: 评分变化处理
- **功能**: 评分或状态变化时重新计算平均评分
- **业务价值**: 确保评分数据的实时性和准确性

### 8. 退款管理触发器

#### 8.1 Refund 表触发器

**tr_refund_before_insert**
- **触发时机**: INSERT 前
- **业务对应**: 退款申请验证
- **功能**:
  - 验证订单存在性和支付状态
  - 验证退款金额不超过订单金额
  - 自动设置退款时间
- **业务价值**: 确保退款申请的合法性

**tr_refund_after_insert**
- **触发时机**: INSERT 后
- **业务对应**: 退款完成处理
- **功能**: 退款成功时自动更新订单状态
- **业务价值**: 自动化退款流程，确保状态一致性

## 定时任务事件

### 1. 座位锁定清理

**ev_cleanup_expired_seat_locks**
- **执行频率**: 每5分钟
- **业务对应**: 座位锁定超时处理
- **功能**: 释放超过15分钟的座位锁定
- **业务价值**: 防止座位长期被锁定，提高座位利用率

### 2. 团购票过期处理

**ev_deactivate_expired_group_tickets**
- **执行频率**: 每1小时
- **业务对应**: 团购票生命周期管理
- **功能**: 自动下架过期的团购票
- **业务价值**: 自动化票型管理，避免无效销售

### 3. 验证码清理

**ev_cleanup_expired_verifications**
- **执行频率**: 每1天
- **业务对应**: 历史数据清理
- **功能**: 删除30天前的已使用验证码
- **业务价值**: 优化数据库性能，减少存储空间

## 业务流程对应关系

### 1. 用户注册流程
```
用户提交注册信息 → tr_user_before_insert 验证 → 创建用户记录
```

### 2. 会员注册流程
```
用户申请会员 → tr_member_before_insert 验证 → 创建会员记录 → 初始化积分
```

### 3. 场次创建流程
```
管理员创建场次 → tr_screening_before_insert 验证 → 创建场次记录 → tr_screening_after_insert 初始化座位
```

### 4. 购票流程
```
用户选择座位 → 座位锁定 → tr_screening_seat_after_update 更新剩余座位 → 创建订单 → tr_order_before_insert 生成订单号 → 支付成功 → 生成验证券 → tr_verification_before_insert 生成核验码
```

### 5. 核销流程
```
用户到场核销 → 验证核验码 → tr_verification_after_update 标记使用 → 座位状态更新
```

### 6. 退款流程
```
用户申请退款 → tr_refund_before_insert 验证 → 处理退款 → tr_refund_after_insert 更新订单状态 → tr_order_after_update 释放座位
```

### 7. 评论流程
```
用户提交评论 → tr_review_before_insert 验证观影资格 → 创建评论 → tr_review_after_insert 更新电影评分
```

### 8. 团购票购买流程
```
用户购买团购票 → tr_purchased_group_ticket_before_insert 验证 → 创建购买记录 → tr_purchased_group_ticket_after_insert 扣减库存
```

## 技术特性

### 1. 数据完整性保障
- 外键约束验证
- 业务规则验证
- 数据格式验证
- 逻辑一致性检查

### 2. 自动化业务处理
- 订单号自动生成
- 核验码自动生成
- 座位自动初始化
- 评分自动计算
- 库存自动管理

### 3. 系统效率优化
- 定时清理过期数据
- 自动释放锁定资源
- 批量状态更新
- 实时数据同步

### 4. 安全性保障
- 敏感操作记录
- 权限验证
- 数据变更追踪
- 异常状态处理

## 部署说明

### 1. 执行顺序
1. 确保数据库表已创建（执行 init.sql）
2. 执行触发器创建脚本（triggers.sql）
3. 启用事件调度器（已包含在脚本中）

### 2. 验证方法
```sql
-- 查看触发器
SELECT TRIGGER_NAME, EVENT_MANIPULATION, EVENT_OBJECT_TABLE, ACTION_TIMING
FROM INFORMATION_SCHEMA.TRIGGERS 
WHERE TRIGGER_SCHEMA = 'tianyoudb';

-- 查看事件
SELECT EVENT_NAME, EVENT_TYPE, INTERVAL_VALUE, INTERVAL_FIELD, STATUS
FROM INFORMATION_SCHEMA.EVENTS 
WHERE EVENT_SCHEMA = 'tianyoudb';
```

### 3. 注意事项
- 确保 MySQL 版本支持事件调度器
- 定时任务需要 event_scheduler 开启
- 触发器中的日志记录功能需要创建对应的日志表
- 建议在测试环境充分验证后再部署到生产环境

## 总结

本触发器系统完美对应电影票务网站的业务流程，通过自动化处理减少了人工干预，提高了数据一致性和系统可靠性。触发器设计遵循了以下原则：

1. **业务导向**: 每个触发器都对应具体的业务场景
2. **数据完整性**: 确保数据的准确性和一致性
3. **自动化**: 减少人工操作，提高效率
4. **安全性**: 防止非法操作和数据损坏
5. **可维护性**: 代码结构清晰，易于理解和维护

这些触发器为电影票务网站提供了强大的数据管理和业务自动化能力，是系统稳定运行的重要保障。